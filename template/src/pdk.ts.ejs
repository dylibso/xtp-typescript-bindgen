<% if (schema.imports.length > 0) { %>
const hostFunctions = Host.getFunctions()
<% } %>

function isNull(v: any): boolean {
  return v === undefined || v === null
}

function cast(caster: (v: any) => any, v: any): any {
  if (isNull(v)) return v
  if (Array.isArray(v)) return v.map(caster)
  return caster(v)
}

export function mapFromJson<T>(obj: any, cast: (value: any) => T): Record<string, T> {
  const result: Record<string, T> = {};

  if (!obj) return result
  
  for (const [key, value] of Object.entries(obj)) {
      result[key] = cast(value);
  }
  
  return result;
}

export function mapToJson<T>(obj: Record<string, T>, cast: (value: T) => any): any {
  const result: Record<string, any> = {};
  
  if (!obj) return result

  for (const [key, value] of Object.entries(obj)) {
    result[key] = cast(value);
  }
  
  return result;
}

function dateToJson(v: Date): string {
  return v.toISOString()
}
function dateFromJson(v: string): Date {
  return new Date(v)
}

function bufferToJson(v: ArrayBuffer): string {
  return Host.arrayBufferToBase64(v)
}
function bufferFromJson(v: string): ArrayBuffer {
  return Host.base64ToArrayBuffer(v)
}

<% Object.values(schema.schemas).forEach(schema => { %>
  <% if (schema.properties.length > 0) { %>

/**
 * <%- formatCommentBlock(schema.description) %>
 */
export class <%- schema.name %> {
  <% schema.properties.forEach(p => { %>
  <% if (p.description) { %>

  /**
   * <%- formatCommentBlock(p.description) %>
   */
  <% } -%>
  <%- (p.nullable || toTypeScriptType(p) === 'any') ? null : '// @ts-expect-error TS2564\n' -%>
  <%- p.name %><%- p.nullable ? '?' : null %>: <%- toTypeScriptType(p) %>;
  <% }) %>

  static fromJson(obj: any): <%- schema.name %> {
    return {
      ...obj,
      <% schema.properties.forEach(p => { -%>
        <% let prop = propertyParsingSnippet(p) -%>
        <% if (prop) { -%>
          <%- p.name -%>: <%- prop %>,
        <% } -%>
      <% }) -%>
    }
  }

  static toJson(obj: <%- schema.name %>): any {
    return {
      ...obj,
      <% schema.properties.forEach(p => { -%>
        <% let prop = propertyToJsonSnippet(p) -%>
        <% if (prop) { -%>
          <%- p.name %>: <%- prop %>,
        <% } -%>
      <% }) -%>
    }
  }
}
  <% } else if (schema.enum) { %>

/**
 * <%- formatCommentLine(schema.description) %>
 */
export enum <%- schema.name %> {
  <% schema.enum.forEach(variant => { -%>
    <%- variant
        // "host:foo$bar" -> "host_Foo$bar"
        .replace(/[^a-zA-Z0-9_$]+(.)?/g, (a, m) => '_' + (m ||'').toUpperCase())
        // "13" -> "$13" ("$" is a valid identifier char; with apologies to jquery)
        .replace(/^([^a-zA-Z_$])/, (a, m) => `$${m}`)
        // "host_Foo_Bar" -> "Host_Foo_Bar"
        .replace(/^(.)/, (a, m) => m.toUpperCase())
    %> = "<%- variant %>",
  <% }) -%>
}

  <% } %>

<% }) %>

<% schema.imports.forEach(imp => { %>
<% if (hasComment(imp)) -%>
/**
 * <%- formatCommentBlock(imp.description) %>
 *
<% if (hasComment(imp.input)) { -%>
 * @param {<%- toTypeScriptType(imp.input) %>} input - <%- formatCommentLine(imp.input.description) %>
<% } -%>
<% if (hasComment(imp.output)) { -%>
 * @returns {<%- toTypeScriptType(imp.output) %>} <%- formatCommentLine(imp.output.description) %>
<% } -%>
 */
export function <%- imp.name %>(<%- imp.input ? `input: ${toTypeScriptType(imp.input)}` : null %>) <%- imp.output ? `:${toTypeScriptType(imp.output)}` : null %> {
<% if (imp.input) { -%>
  <% if (isJsonEncoded(imp.input)) { -%>
    <% if (isPrimitive(imp.input)) { %>
      const mem = Memory.fromJsonObject(input as any)
    <% } else if (isMap(imp.input)) { %>
      const serialized = <%- mapToJsonSnippet('input', imp.input) %>
      const mem = Memory.fromJsonObject(serialized)
    <% } else { %>
      const casted = <%- toTypeScriptType(imp.input) %>.toJson(input)
      const mem = Memory.fromJsonObject(casted)
    <% } %>
  <% } else if (isUtf8Encoded(imp.input)) { -%>
  const mem = Memory.fromString(input as string)
  <% } else if (imp.input.type === 'string') { -%>
  const mem = Memory.fromString(input)
  <% } else { -%>
  const mem = Memory.fromBuffer(input)
  <% } -%>

  <% if (imp.output) { -%>const ptr =<% } -%> hostFunctions.<%- imp.name %>(mem.offset)
<% } else { -%>
  <% if (imp.output) { -%>const ptr =<% } -%> hostFunctions.<%- imp.name %>()
<% } -%>

<% if (imp.output) { -%>
  <% if (isJsonEncoded(imp.output)) { -%>
    <% if (isPrimitive(imp.output)) { -%>
      return Memory.find(ptr).readJsonObject();
    <% } else if (isMap(imp.output)) { -%>
      const output = Memory.find(ptr).readJsonObject();
      return <%- mapParsingSnippet('output', imp.output) %>
    <% } else { -%>
      const output = Memory.find(ptr).readJsonObject();
      return <%- toTypeScriptType(imp.output) %>.fromJson(output)
    <% } -%>
  <% } else if (isUtf8Encoded(imp.output)) { -%>
    return Memory.find(ptr).readString();
  <% } else if (imp.output.type === 'string') { -%>
    return Memory.find(ptr).readString();
  <% } else { -%>
    return Memory.find(ptr).readBytes();
  <% } -%>
<% } %>
}
<% }) %>
